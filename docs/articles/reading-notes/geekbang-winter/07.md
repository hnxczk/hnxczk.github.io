# 从 ECMAScript 规范中解读 this

大部分介绍 this 的文章都是从现象出发，然后总结规律。虽然说这也是一种方式，但这样以来就如同盲人摸象，只看到了局部而不能解释全局。前段时间看到有人从 ECMAScript 规范的角度来解读 this。我觉得这种方式不错，虽然可能有点晦涩难懂，不过它却能透过现象看到本质，不失为一种好的方法。

[https://www.w3.org/html/ig/zh/wiki/ES5](https://www.w3.org/html/ig/zh/wiki/ES5)

## 纠正

有些观点认为：this 的值取决于函数如何定义，如果它是全局函数，this 设置为全局对象，如果函数是一个对象的方法，this 将总是指向这个对象。

这是不正确的。通过前面[《执行上下文和执行栈》](./05md) 这篇文章我们知道函数执行的时候会创建执行上下文，而在执行上下文生成的过程中，会分别确定变量对象，作用域链，以及 this 的值。因此 this 的值在进入上下文时就确定了。而且在函数代码中，this 的值在每一次(进入上下文时)可能完全不同。但是不管怎样，在代码运行期间，this的值是不变的。

## 函数调用

知道了 this 是在函数调用的时候确定的之后我们就去函数调用的规范去看看具体是如何确定的。

[函数调用](https://www.w3.org/html/ig/zh/wiki/ES5/%E8%A1%A8%E8%BE%BE%E5%BC%8F#.E5.87.BD.E6.95.B0.E8.B0.83.E7.94.A8)

The production CallExpression : MemberExpression Arguments is evaluated as follows:

1. **Let ref be the result of evaluating MemberExpression.**
2. **Let func be GetValue(ref).**
3. Let argList be the result of evaluating Arguments, producing an internal list of argument values (see 11.2.4).
4. If Type(func) is not Object, throw a TypeError exception.
5. If IsCallable(func) is false, throw a TypeError exception.
6. **If Type(ref) is Reference, then**
   - **If IsPropertyReference(ref) is true, then
Let thisValue be GetBase(ref).**
   - **Else, the base of ref is an Environment Record
Let thisValue be the result of calling the ImplicitThisValue concrete method of GetBase(ref).**
7. **Else, Type(ref) is not Reference.**
    - **Let thisValue be undefined.**
8. Return the result of calling the [[Call]] internal method on func, providing thisValue as the this value and providing the list argList as the argument values.

上面有许多不认识的方法和类型，这需要我们先了解一下引用类型（Reference type）。

## 类型

在 ECMAScript 标准中类型分为 语言类型(Language Type) 和 规范类型(Specification Type)。

其中的语言类型就是语言中直接操作的类型，比如 Undefined、Null、Boolean、String、Number、Object。这些事我们平时所接触的到的。

规范类型用来描述表达式求值过程的中间结果，是一种内部实现，不对程序员直接开放。ECMAScript 规范使用规范类型来自洽地描述其内部作用机制，平时我们接触不到。

规范类型包括：Reference, List, Completion, Property Descriptor, Property Identifier, Lexical Environment, Environment Record。

## 引用类型（Reference type）

Reference 类型是 ECMAScript 规范用来解释 delete 、 typeof 、赋值运算符等语言特性的行为的。

Reference 表示的是对某个变量、数组元素或对象属性所在内存地址的引用，而非对其所在内存地址所保存值的引用。在 ECMAScript 中，赋值运算符的左侧只能是一个内存地址，而不能是一个值。（其实很好理解，你可以把值保存在某个内存地址，而不能把值赋给另一个值）

[出处](https://www.zhihu.com/question/31911373/answer/54055480)

Reference 的构成，由三个组成部分，分别是：

- base value
  - 所处的环境或者所在的对象
  - 它的值只可能是 Undefined, Object, Boolean, String, Number, 环境变量 其中的一种。
- referenced name
  - referenced 的名字
  - 是一个字符串
- strict mode flag
  - 用来检测严格下的一些限制的标志位

例子

```javascript
var foo = 1

var fooReference = {
    base: EnvironmentRecord,
    name: 'foo',
    strict: false
}
```
```javascript
var foo = {
    bar: function () {
        return this;
    }
};
 
foo.bar() 

var BarReference = {
    base: foo,
    name: 'bar',
    strict: false
}
```

### Reference 相关方法

#### 1. GetValue()

用于从 Reference 获取对应值。

```javascript
var foo = 1;

var fooReference = {
    base: EnvironmentRecord,
    name: 'foo',
    strict: false
};

GetValue(fooReference) // 1;
```

调用 GetValue，返回的将是具体的语言类型的值，而不再是一个 Reference

#### 2. GetBase()

返回 Reference 的 base value

#### 3. HasPrimitiveBase()

如果 Reference 的 base value 是 Boolean、String、Number，那么返回 true。

#### 4. IsPropertyReference()

如果 Reference 的 base value 是个 Object 或 HasPrimitiveBase(V) 是 true，那么返回 true；否则返回 false。

也就是说 如果 Reference 的 base value 是个 Object、Boolean、String、Number 返回 true；否则返回 false。


## 分析

了解过 Reference type 之后我们将函数调用精简一下，仅留下与 this 相关的内容。

1. **Let ref be the result of evaluating MemberExpression.**
2. **Let func be GetValue(ref).**
3. ...
4. ...
5. ...
6. **If Type(ref) is Reference, then**
   - **If IsPropertyReference(ref) is true, then
Let thisValue be GetBase(ref).**
   - **Else, the base of ref is an Environment Record
Let thisValue be the result of calling the ImplicitThisValue concrete method of GetBase(ref).**
7. **Else, Type(ref) is not Reference.**
    - **Let thisValue be undefined.**
8. ...

```

```
