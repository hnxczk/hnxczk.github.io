# 趣谈网络协议学习记录
## 0. 开篇词
略
## 1. 为什么要学习网络协议？
### 协议三要素
```
public class HelloWorld {
	public static void main(String[] args) {
		System.out.println("Hello World!");
	}
}
```
上面是计算机语言中的一种，它可以看成程序员控制一台计算机工作的协议。具备了协议的三要素。

- 语法，就是这一段内容要符合一定的规则和格式。例如，括号要成对，结束要使用分号等。
- 语义，就是这一段内容要代表某种意义。例如数字减去数字是有意义的，数字减去文本一般来说就没有意义。
- 顺序，就是先干啥，后干啥。例如，可以先加上某个数值，然后再减去某个数值。

```
HTTP/1.1 200 OK
Date: Tue, 27 Mar 2018 16:50:26 GMT
Content-Type: text/html;charset=UTF-8
Content-Language: zh-CN

<!DOCTYPE html>
<html>
<head>
<base href="https://pages.kaola.com/" />
<meta charset="utf-8"/> <title> 网易考拉 3 周年主会场 </title>
```
上面是 HTTP 协议，同样符合协议的三要素

- 语法，也就是说，只有按照上面那个格式来，浏览器才认。例如，上来是状态，然后是首部，然后是内容。
- 语义，就是要按照约定的意思来。例如，状态 200，表述的意思是网页成功返回。如果不成功，就是我们常见的“404”。
- 顺序，你一点浏览器，就是发送出一个 HTTP 请求，然后才有上面那一串 HTTP 返回的东西。
 综上可以看出所有的协议都有语法、语义、顺序这三大要素。

### 从浏览器里面下单到浏览器呈现内容这一过程中涉及的协议

1. 浏览器中点击下单后浏览器根据 URL 通过地址簿协议 DNS 或者更加精准的地址簿查找协议HTTPDNS去查找 IP 地址。
2. 浏览器就开始打包它的请求。使用 HTTP 协议或者进行加密传输的 HTTPS 协议。协议里面都会写明“你要买什么和买多少”。
	
	![](./images/study-network-1.png)
	
3. 上面 DNS、HTTP 所处的层称之为**应用层**。
4. 接下来由**传输层**来进行处理。传输层有两种协议，一种是无连接的协议 UDP，一种是面向连接的协议 TCP。所谓的面向连接意思就是，TCP 会保证这个包能够到达目的地。如果不能到达，就会重新发送，直至到达。TCP 协议里面会有两个端口，一个是浏览器监听的端口，一个是电商的服务器监听的端口。操作系统往往通过端口来判断，它得到的包应该给哪个进程。

	![](./images/study-network-2.png)

5. 然后是**网络层**的 IP 协议。在 IP 协议里面会有源 IP 地址，即浏览器所在机器的 IP 地址和目标 IP 地址。

	![](./images/study-network-3.png)

6. IP 地址相当于门牌号，可以通过它看出这个目标 IP 地址是本地人，还是外地人。如果是外地的就需要先查找网关。
7. 由于操作系统启动的时候，就会被 DHCP 协议配置 IP 地址，以及默认的网关的 IP 地址 192.168.1.1。这样以来可以通过 ARP 协议获取网关的 MAC 地址。这样以来就把 IP 包交给了 **MAC层**。
	
	![](./images/study-network-4.png)
	
8. 网关（往往是一个路由器）收到包之后，会根据自己的路由表，判断下一步到某个 IP 地址应该怎么走。
9. 路由器有点像玄奘西行路过的一个个国家的一个个城关。每个城关都连着两个国家，每个国家相当于一个局域网，在每个国家内部，都可以使用本地的地址 MAC 进行通信。
10. 一旦跨越城关，就需要拿出 IP 头来，里面写着贫僧来自东土大唐（就是源 IP 地址），欲往西天拜佛求经（指的是目标 IP 地址）。路过宝地，借宿一晚，明日启行，请问接下来该怎么走啊？
11. 城关往往是知道接下来该怎么走的，因为城关和临近的城关也会经常沟通。到哪里应该怎么走，这种沟通的协议称为路由协议，常用的有OSPF和BGP。
12. 走到最后一个城关知道了自己就是这个网络包要去的地方。于是，对着自己所在的国家吼一声，谁是目标 IP 啊？目标服务器就会回复一个 MAC 地址。网络包过关后，通过这个 MAC 地址就能找到目标服务器。
13. 目标服务器发现 MAC 地址对上了，取下 MAC 头来，发送给操作系统的网络层。发现 IP 也对上了，就取下 IP 头。IP 头里会写上一层封装的是 TCP 协议，然后将其交给传输层，即 TCP 层。
14. 到达 TCP 层之后，TCP 头中有目标端口号，通过这个端口号，可以找到电商网站的进程正在监听这个端口号，假设一个 Tomcat，将这个包发给电商网站。
15. 电商网站的进程得到 HTTP 请求的内容，知道了要买东西，买多少。然后返回相应的内容的 HTTPS 的包。这个包，会像来的时候一样，经过千难万险到达你的个人电脑，最终进入浏览器，显示支付成功。

## 2. 网络分层的真实含义是什么？

### 不恰当的比喻
教科书或者老师往往会打一个十分不恰当的比喻：为什么网络要分层呀？因为不同的层次之间有不同的沟通方式，这个叫作协议。例如，一家公司也是分“层次”的，分总经理、经理、组长、员工。总经理之间有他们的沟通方式，经理和经理之间也有沟通方式，同理组长和员工。

#### 不恰当的原因
**所有不能表示出层层封装含义的比喻，都是不恰当的。** 在上面例子中总经理握手，不需要员工在吧，总经理之间谈什么，不需要员工参与吧，但是网络世界不是这样的。

比如 TCP 在三次握手的时候，IP 层和 MAC 层在做什么呢？当然是 TCP 发送每一个消息，都会带着 IP 层和 MAC 层了。因为，TCP 每发送一个消息，IP 层和 MAC 层的所有机制都要运行一遍。而你只看到 TCP 三次握手了，其实，IP 层和 MAC 层为此也忙活好久了。

**只要是在网络上跑的包，都是完整的。可以有下层没上层，绝对不可能有上层没下层。**

所以对 TCP 协议来说，三次握手也好，重试也好，只要想发出去包，就要有 IP 层和 MAC 层，不然是发不出去的。

### 更好的例子-发快递
1. 你准备发一件快递给一个朋友。
2. 快递员查询收件地址的邮编（DNS请求）
3. 打包快递，贴上快递单。（封装请求， 会话层）
4. 快递员封装一层盒子贴上快递单带回网店(传输层）
5. 到快递点检查是否区域快件（网络层）
6. 将快件交给运输车（链路层）
7. 各个快递转运中心（物理层）
8. 快件到达收件市转运中心（物理层）
9. 转运输车（链路层）
10. 到达区域分发（网络层）
11. 网点派送（传输层）
12. 快递员方面签收（会话层）
13. 拆开检查（表示层）
14. 收到快递（应用层）

## 3. ifconfig：最熟悉又陌生的命令行
### 命令行中怎么查看 IP 地址
在 Windows 上是 ipconfig，在 Linux 上是 ifconfig 或者 ip addr。
个别精简 Linux 系统中可能没有这些命令，需要安装 net-tools 和 iproute2 这两个工具。
### IP 地址是一个网卡在网络世界的通讯地址，相当于我们现实世界的门牌号码。
ipv4 中类似 10.100.122.2 就是一个 IP 地址。这个地址被点分隔为四个部分，每个部分 8 个 bit，所以 IP 地址总共是 32 位。
ipv4 的 IP 地址最初的时候被分成了以下 5 类。

![](./images/study-network-5.png)

对于 A、B、 C 类主要分两部分，前面一部分是网络号，后面一部分是主机号。比如大家都是六单元 1001 号，我是小区 A 的六单元 1001 号，而你是小区 B 的六单元 1001 号。网络号就是小区名称，主机好就是具体单元。

下面这个表格，详细地展示了 A、B、C 三类地址所能包含的主机的数量。

![](./images/study-network-6.png)

### 无类型域间选路（CIDR）

通过上面的表格可以看出 C 类地址包含的最大主机数太少了，而 B 类地址包含的又太多。在实际的使用过程中出现了各种问题。于是无类型域间选路（CIDR） 出现了。

将 32 位的 IP 地址一分为二，前面是网络号，后面是主机号。从哪里分呢？你如果注意观察的话可以看到，10.100.122.2/24，这个 IP 地址中有一个斜杠，斜杠后面有个数字 24。这种地址表示形式，就是 CIDR。后面 24 的意思是，32 位中，前 24 位是网络号，后 8 位是主机号。

伴随着 CIDR 存在的，一个是广播地址（broadcast），10.100.122.255。如果发送这个地址，所有 10.100.122 网络里面的机器都可以收到。另一个是子网掩码（netmask），255.255.255.0。

将子网掩码和 IP 地址进行 AND 计算。前面三个 255，转成二进制都是 1。1 和任何数值取 AND，都是原来数值，因而前三个数不变，为 10.100.122。后面一个 0，转换成二进制是 0，0 和任何数值取 AND，都是 0，因而最后一个数变为 0，合起来就是 10.100.122.0。这就是网络号。将子网掩码和 IP 地址按位计算 AND，就可得到网络号。

对于 16.158.165.91/22 这种不是 8 的整数倍的 CIDR 来说需要需要把它转化成二进制来看。16.158 的部分不会动，它占了前 16 位。中间的 165，变为二进制为10100101。除了前面的 16 位，还剩 6 位。所以，这 8 位中前 6 位是网络号，16.158.<101001>，而<01>.91 是机器号。

第一个地址是 16.158.<101001><00>.1，即 16.158.164.1。子网掩码是 255.255.<111111><00>.0，即 255.255.252.0。广播地址为 16.158.<101001><11>.255，即 16.158.167.255。

### 公有 IP 地址和私有 IP 地址
私有 IP 地址就像每个小区有自己的楼编号和门牌号，不同小区都可以有各个相同的编号。而公有 IP 就像街道名称，这个是政府进行分配管理的。 

192.168.0.x 是最常用的私有 IP 地址。能明显看出 192.168.0 是网络号，后面是主机号。而整个网络里面的第一个地址 192.168.0.1，往往就是你这个私有网络的出口地址。例如，你家里的电脑连接 Wi-Fi，Wi-Fi 路由器的地址就是 192.168.0.1，而 192.168.0.255 就是广播地址。一旦发送这个地址，整个 192.168.0 网络里面的所有机器都能收到。

### 解析
下面这个是 mac 上执行 ifconfig 后的部分输出
```
①lo0: flags=8049<UP,LOOPBACK,RUNNING,MULTICAST> mtu 16384
	options=1203<RXCSUM,TXCSUM,TXSTATUS,SW_TIMESTAMP>
	inet 127.0.0.1 netmask 0xff000000
	inet6 ::1 prefixlen 128
	inet6 fe80::1%lo0 prefixlen 64 scopeid 0x1
	nd6 options=201<PERFORMNUD,DAD>
①en0: ④flags=8863<UP,BROADCAST,SMART,RUNNING,SIMPLEX,MULTICAST> ⑤mtu 1500
	options=10b<RXCSUM,TXCSUM,VLAN_HWTAGGING,AV>
	③ether 78:7b:8a:d2:0d:65
	②inet6 fe80::b8:d1f6:4d2:dab5%en0 prefixlen 64 secured scopeid 0x6
	②inet 192.168.1.190 netmask 0xffffff00 broadcast 192.168.1.255
	nd6 options=201<PERFORMNUD,DAD>
	media: autoselect (100baseTX <full-duplex>)
	status: active
```
① 

- lo 全称是loopback，又称环回接口，往往会被分配到 127.0.0.1 这个地址。这个地址用于本机通信，经过内核处理后直接返回，不会在任何网络中出现。
- en 以太网接口，以太网接口与网卡对应，每个硬件网卡(一个MAC)对应一个以太网接口。

②

- inet: ipv4/ netmask: 子网掩码/ broadcast: 广播地址
- inet6: ipv6

③

- ether MAC 地址。MAC 地址全局唯一，不会有两个网卡有相同的 MAC 地址，而且网卡自生产出来，就带着这个地址。

④

网络设备的状态标识

- UP 表示网卡处于启动的状态；
- BROADCAST 表示这个网卡有广播地址，可以发送广播包；
- MULTICAST 表示网卡可以发送多播包；
- LOWER_UP 表示 L1 是启动的，也即网线插着呢。
- MTU1500 是指最大传输单元 MTU 为 1500，这是以太网的默认值。MTU 是二层 MAC 层的概念。MAC 层有 MAC 的头，以太网规定连 MAC 头带正文合起来，不允许超过 1500 个字节。正文里面有 IP 的头、TCP 的头、HTTP 的头。如果放不下，就需要分片来传输。

### MAC 地址
MAC 地址是一个很容易让人“误解”的地址。因为 MAC 地址号称全局唯一。很多人看到这里就会想，既然这样，整个互联网的通信，全部用 MAC 地址好了，只要知道了对方的 MAC 地址，就可以把信息传过去。

这样当然是不行的。一个网络包要从一个地方传到另一个地方，除了要有确定的地址，还需要有定位功能。而有门牌号码属性的 **IP 地址，才是有远程定位功能的**。

**MAC 地址更像是身份证，是一个唯一的标识**。它的唯一性设计是为了组网的时候，不同的网卡放在一个网络里面的时候，可以不用担心冲突。从硬件角度，保证不同的网卡有不同的标识。

MAC 地址是有一定定位功能的，只不过范围非常有限。你可以根据 IP 地址，找到杭州市网商路 599 号 B 楼 6 层，但是依然找不到我，你就可以靠吼了，大声喊身份证 XXXX 的是哪位？我听到了，我就会站起来说，是我啊。但是如果你在上海，到处喊身份证 XXXX 的是哪位，我不在现场，当然不会回答，因为我在杭州不在上海。

所以，MAC 地址的通信范围比较小，局限在一个子网里面。例如，从 192.168.0.2/24 访问 192.168.0.3/24 是可以用 MAC 地址的。一旦跨子网，即从 192.168.0.2/24 到 192.168.1.2/24，MAC 地址就不行了，需要 IP 地址起作用了。


## 4. DHCP 与 PXE：IP 是怎么来的，又是怎么没的？

### 如何配置 IP 地址？
可以自己利用命令行来配置 IP 地址。但是不按一定规则来配置的话就无法正常连接。

比如 192.168.1.6 就在你自己这台机器的旁边，甚至是在同一个交换机上，而你把自己的机器的地址设为了 16.158.23.6。这时当你往旁边的机器发送数据包的时候，知道了自己的 IP 地址，目标的 IP 地址 以及自己的 MAC 地址。还需要知道目的地的 MAC 地址，这时系统首先会判断，要去的这个地址和我是一个网段的吗，或者和我的一个网卡是同一网段的吗？只有是一个网段的，它才会发送 ARP 请求，获取 MAC 地址。如果发现不是它会发给网关，但是网关配置的时候系统会要求网关要和当前的网络至少一个网卡是同一个网段的。因此这样配置是显然不行的。因此手动配置 IP 的时候需要询问网络管理员，让他给分配合适的 IP。这样以来当局域网内的机器多起来，或者机器发生变动的时候都需要网络管理员来配置，这无疑是反人类的工作。

### 动态主机配置协议（DHCP）
动态主机配置协议（Dynamic Host Configuration Protocol），简称DHCP，它是一个自动配置 IP 的协议。DHCP 的方式就相当于租房。你不用装修，都是帮你配置好的。你暂时用一下，用完退租就可以了。

解析 DHCP 的工作方式

1. DHCP Discover
	当一台机器新加入一个网络的时候，使用 IP 地址 0.0.0.0 ，以 IP 地址 255.255.255.255 这个广播地址为目的地址发送了一个广播包。里面是自己的 MAC 地址。
	
	![](./images/study-network-7.png)

2. DHCP Offer

	网络管理员在网络里面配置的 DHCP Server 会收到这个广播。由于 MAC 地址的唯一性 DHCP Server 就能知道这是个新来的机器，需要租给它一个 IP 地址。这时候 sever 以  255.255.255.255 这个广播地址为目的地址发送广播包。里面是之前接收的 MAC 地址以及新分配的 IP 地址。
	
	![](./images/study-network-8.png)

3. DHCP Request

	新来的机器选取最先到达的 DHCP Offer ，然后发送一个 DHCP Request 广播包，里面是自己的 MAC 地址、接受的 IP 地址、提供 Offer 的 Sever 服务器地址等。通过这个广播来告诉所有的 Sever 自己接受了哪个 IP 地址。这样以来其他 Sever 就会撤销刚刚分配的 IP 地址，留待后用。
	
	由于还没有得到 DHCP Server 的最后确认，客户端仍然使用 0.0.0.0 为源 IP 地址、255.255.255.255 为目标地址进行广播。

	![](./images/study-network-9.png)
	
4. DHCP ACK

	当 DHCP Server 接收到客户机的 DHCP request 之后，会广播返回给客户机一个 DHCP ACK 消息包，表明已经接受客户机的选择，并将这一 IP 地址的合法租用信息和其他的配置信息都放入该广播包，发给客户机。
	
	![](./images/study-network-10.png)
	
### IP 地址的收回和续租

既然是租房子，就是有租期的。租期到了，管理员就要将 IP 收回。

客户机会在租期过去 50% 的时候，直接向为其提供 IP 地址的 DHCP Server 发送 DHCP request 消息包。客户机接收到该服务器回应的 DHCP ACK 消息包，会根据包中所提供的新的租期以及其他已经更新的 TCP/IP 参数，更新自己的配置。这样，IP 租用更新就完成了。

### 预启动执行环境（PXE）
简单了解了下，简单来说就是通过配置 DHCP Server 来租给 PXE 客户端一个 IP 地址，同时也给它 PXE 服务器的地址、启动文件 pxelinux.0，然后去 PXE 服务器下载这个文件后，就可以初始化机器。

![](./images/study-network-11.png)


## 5. 从物理层到 MAC 层：如何在宿舍里自己组网玩联机游戏？

### 第一层（物理层）
如果有一根网线一头插在一台电脑的网卡上，另一头插在另一台电脑的网卡上。普通的网线这样是通不了的（现在的网卡已经能自适应直连线了），这是因为水晶头的第 1、2 和第 3、6 脚，它们分别起着收、发信号的作用。这时候需要将一端的 1 号和 3 号线、2 号和 6 号线互换一下位置，就能够在物理层实现一端发送的信号，另一端能收到。这就是所谓的**1－3、2－6 交叉接法**。

连好电脑后还需要配置电脑的 IP 地址、子网掩码和默认网关，这些要按照上一节中介绍的相应规则配好。

把三台电脑连在一起的时候还需要一个叫作 Hub 的东西，也就是集线器。这种设备有多个口，可以将多台电脑连接起来。但是，和交换机不同，集线器没有大脑，它完全在物理层工作。它会将自己收到的每一个字节，都复制到其他端口上去。这是第一层物理层联通的方案。

### 第二层（数据链路层）
数据链路层，也即 MAC 层。MAC 的全称是 Medium Access Control，即媒体访问控制。它解决以下几个问题。

1.	这个包是发给谁的？谁应该接收？

	为了解决这个问题用到一个物理地址，叫作链路层地址。但是因为第二层主要解决媒体接入控制的问题，所以它常被称为MAC 地址。
	
2.	大家都在发，会不会产生混乱？有没有谁先发、谁后发的规则？

	这个问题的解决方案叫**多路访问**，主要由以下三种方式。
	
	- 方式一：分多个车道。每个车一个车道，你走你的，我走我的。这在计算机网络里叫作**信道划分**；
	- 方式二：今天单号出行，明天双号出行，轮着来。这在计算机网络里叫作**轮流协议**；
	- 方式三：不管三七二十一，有事儿先出门，发现特堵，就回去。错过高峰再出。我们叫作**随机接入协议**。著名的以太网，用的就是这个方式。
3.	如果发送的时候出现了错误，怎么办？

#### 第二层的网络包格式 
对于以太网，第二层开头就是目标的 MAC 地址和源的 MAC 地址。

![](./images/study-network-12.jpg)

上图中所示的**类型**，大部分的类型是 IP 数据包，然后 IP 里面包含 TCP、UDP，以及 HTTP 等，这都是里层封装的事情。

上图中的 **CRC**，称为循环冗余检测。通过 XOR 异或的算法，来计算整个包是否在发送的过程中出现了错误。这个用来解决第三个问题。

通过这个目标 MAC 地址，数据包在链路上广播时，MAC 的网卡才能发现这个包是给它的。MAC 的网卡把包收进来，然后打开 IP 包，发现 IP 地址也是自己的，再打开 TCP 包，发现端口是自己，也就是 80，而 nginx 就是监听 80。
于是将请求提交给 nginx，nginx 返回一个网页。然后将网页需要发回请求的机器。然后层层封装，最后到 MAC 层。因为来的时候有源 MAC 地址，返回的时候，源 MAC 就变成了目标 MAC，再返给请求的机器。


### ARP 协议
当一个电脑知道目的电脑的 IP 地址的时候需要知道目的电脑的 MAC 地址。这样以来才能发出正确格式的网络包。这时候就需要 ARP 协议，也就是已知 IP 地址，求 MAC 地址的协议。

![](./images/study-network-13.png)

简单来说就是广而告之，发送一个广播包，谁是这个 IP 谁来回答。为了避免每次都用 ARP 请求，机器本地也会进行 ARP 缓存。当然机器会不断地上线下线，IP 也可能会变，所以 ARP 的 MAC 地址缓存过一段时间就会过期。

### 交换机

当局域网中机器数目少的时候通过 Hub 来连接是没什么问题的，但是一旦机器数目增多，问题就出现了。因为 Hub 是广播的，不管某个接口是否需要，所有的 Bit 都会被发送出去，然后让主机来判断是不是需要。这种方式路上的车少就没问题，车一多，产生冲突的概率就提高了。而且把不需要的包转发过去，纯属浪费。

这时候需要使用另外一种二层设备:**交换机**。

交换机是一个能把 MAC 头拿下来，检查一下目标 MAC 地址，然后根据策略转发的设备。

而且当一台 MAC1 电脑将一个包发送给另一台 MAC2 电脑时，当这个包到达交换机的时候，一开始交换机也不知道 MAC2 的电脑在哪个口，所以没办法，它只能将包转发给出了来的那个口之外的其他所有的口。但是，这个时候，交换机会干一件非常聪明的事情，就是交换机会记住，MAC1 是来自一个明确的口。以后有包的目的地址是 MAC1 的，直接发送到这个口就可以了。

当交换机作为一个关卡一样，过了一段时间之后，就有了整个网络的一个结构了，这个时候，基本上不用广播了，全部可以准确转发。当然，每个机器的 IP 地址会变，所在的口也会变，因而交换机上的学习的结果，我们称为转发表，是有一个过期时间的。

Q&A

1. 在二层中我们讲了 ARP 协议，即已知 IP 地址求 MAC；还有一种 RARP 协议，即已知 MAC 求 IP 的，你知道它可以用来干什么吗？

	之前有无盘工作站，即没有硬盘的机器，无法持久化ip地址到本地，但有网卡，所以可以用RARP协议来获取IP地址。RARP可以用于局域网管理员想指定机器IP（与机器绑定，不可变），又不想每台机器去设置静态IP的情况，可以在RARP服务器上配置MAC和IP对应的ARP表，不过获取每台机器的MAC地址，好像也挺麻烦的。这个协议现在应该用得不多了吧，都用BOOTP或者DHCP了。

2. 如果一个局域网里面有多个交换机，ARP 广播的模式会出现什么问题呢？

	ARP广播时，交换机会将一个端口收到的包转发到其它所有的端口上。
	比如数据包经过交换机A到达交换机B，交换机B又将包复制为多份广播出去。
	如果整个局域网存在一个环路，使得数据包又重新回到了最开始的交换机A，这个包又会被A再次复制多份广播出去。
	如此循环，数据包会不停得转发，而且越来越多，最终占满带宽，或者使解析协议的硬件过载，行成广播风暴。

## 6. 交换机与VLAN：办公室太复杂，我要回学校
办公室大多是一排排的桌子，每个桌子都有网口，一排十几个座位就有十几个网口，一个楼层就会有几十个甚至上百个网口。如果算上所有楼层，这个场景自然比宿舍里的复杂多了。
### 拓扑结构是怎么形成的？
![](./images/study-network-14.png)

上图中两台交换机连接着三个局域网，每个局域网上都有多台机器。
- 如果机器 1 只知道机器 4 的 IP 地址，当它想要访问机器 4，把包发出去的时候，它必须要知道机器 4 的 MAC 地址。
- 机器 1 发起广播，机器 2 收到这个广播，但是这不是找它的，所以没它什么事。交换机 A 一开始是不知道任何拓扑信息的，在它收到这个广播后，采取的策略是，除了广播包来的方向外，它还要转发给其他所有的网口。于是机器 3 也收到广播信息了，但是这和它也没什么关系。
- 交换机 B 也是能够收到广播信息的，但是这时候它也是不知道任何拓扑信息的，因而也是进行广播的策略，将包转发到局域网三。这个时候，机器 4 和机器 5 都收到了广播信息。机器 4 主动响应说，这是找我的，这是我的 MAC 地址。于是一个 ARP 请求就成功完成了。

在上面的过程中，交换机 A 和交换机 B 都是能够学习到这样的信息：机器 1 是在左边这个网口的。当了解到这些拓扑信息之后，情况就好转起来。当机器 2 要访问机器 1 的时候，机器 2 并不知道机器 1 的 MAC 地址，所以机器 2 会发起一个 ARP 请求。这个广播消息会到达机器 1，也同时会到达交换机 A。这个时候交换机 A 已经知道机器 1 是不可能在右边的网口的，所以这个广播信息就不会广播到局域网二和局域网三。
当机器 3 要访问机器 1 的时候，也需要发起一个广播的 ARP 请求。这个时候交换机 A 和交换机 B 都能够收到这个广播请求。交换机 A 当然知道主机 A 是在左边这个网口的，所以会把广播消息转发到局域网一。同时，交换机 B 收到这个广播消息之后，由于它知道机器 1 是不在右边这个网口的，所以不会将消息广播到局域网三。

### 如何解决常见的环路问题？

这样看起来，两台交换机工作得非常好。随着办公室越来越大，交换机数目肯定越来越多。当整个拓扑结构复杂了，这么多网线，绕过来绕过去，不可避免地会出现一些意料不到的情况。其中常见的问题就是环路问题。

![](./images/study-network-15.png)

我们来想象一下机器 1 访问机器 2 的过程。一开始，机器 1 并不知道机器 2 的 MAC 地址，所以它需要发起一个 ARP 的广播。广播到达机器 2，机器 2 会把 MAC 地址返回来，看起来没有这两个交换机什么事情。

但是问题来了，这两个交换机还是都能够收到广播包的。交换机 A 一开始是不知道机器 2 在哪个局域网的，所以它会把广播消息放到局域网二，在局域网二广播的时候，交换机 B 右边这个网口也是能够收到广播消息的。交换机 B 会将这个广播息信息发送到局域网一。局域网一的这个广播消息，又会到达交换机 A 左边的这个接口。交换机 A 这个时候还是不知道机器 2 在哪个局域网，于是将广播包又转发到局域网二。左转左转左转，好像是个圈哦。

可能有人会说，当两台交换机都能够逐渐学习到拓扑结构之后，是不是就可以了？

别想了，压根儿学不会的。机器 1 的广播包到达交换机 A 和交换机 B 的时候，本来两个交换机都学会了机器 1 是在局域网一的，但是当交换机 A 将包广播到局域网二之后，交换机 B 右边的网口收到了来自交换机 A 的广播包。根据学习机制，这彻底损坏了交换机 B 的三观，刚才机器 1 还在左边的网口呢，怎么又出现在右边的网口呢？哦，那肯定是机器 1 换位置了，于是就误会了，交换机 B 就学会了，机器 1 是从右边这个网口来的，把刚才学习的那一条清理掉。同理，交换机 A 右边的网口，也能收到交换机 B 转发过来的广播包，同样也误会了，于是也学会了，机器 1 从右边的网口来，不是从左边的网口来。

然而当广播包从左边的局域网一广播的时候，两个交换机再次刷新三观，原来机器 1 是在左边的，过一会儿，又发现不对，是在右边的，过一会，又发现不对，是在左边的。

这还是一个包转来转去，每台机器都会发广播包，交换机转发也会复制广播包，当广播包越来越多的时候，按照上一节讲过一个共享道路的算法，也就是路会越来越堵，最后谁也别想走。所以，必须有一个方法解决环路的问题，怎么破除环路呢？

### STP 协议
在数据结构中，有一个方法叫作**最小生成树**。有环的我们常称为图。将图中的环破了，就生成了树。在计算机网络中，生成树的算法叫作STP，全称 Spanning Tree Protocol。

* Root Bridge，也就是**根交换机**。这个比较容易理解，可以比喻为“掌门”交换机，是某棵树的老大，是掌门，最大的大哥。
* Designated Bridges，有的翻译为**指定交换机**。这个比较难理解，可以想像成一个“小弟”，对于树来说，就是一棵树的树枝。所谓“指定”的意思是，我拜谁做大哥，其他交换机通过这个交换机到达根交换机，也就相当于拜他做了大哥。这里注意是树枝，不是叶子，因为叶子往往是主机。
* Bridge Protocol Data Units （BPDU） ，**网桥协议数据单元**。可以比喻为“相互比较实力”的协议。行走江湖，比的就是武功，拼的就是实力。当两个交换机碰见的时候，也就是相连的时候，就需要互相比一比内力了。BPDU 只有掌门能发，已经隶属于某个掌门的交换机只能传达掌门的指示。
* Priority Vector，**优先级向量**。可以比喻为实力 （值越小越牛）。实力是啥？就是一组 ID 数目，[Root Bridge ID, Root Path Cost, Bridge ID, and Port ID]。为什么这样设计呢？这是因为要看怎么来比实力。先看 Root Bridge ID。拿出老大的 ID 看看，发现掌门一样，那就是师兄弟；再比 Root Path Cost，也即我距离我的老大的距离，也就是拿和掌门关系比，看同一个门派内谁和老大关系铁；最后比 Bridge ID，比我自己的 ID，拿自己的本事比。

##### STP 的工作过程
一开始，江湖纷争，异常混乱。大家都觉得自己是掌门，谁也不服谁。于是，所有的交换机都认为自己是掌门，每个网桥都被分配了一个 ID。这个 ID 里有管理员分配的优先级，当然网络管理员知道哪些交换机贵，哪些交换机好，就会给它们分配高的优先级。这种交换机生下来武功就很高，起步就是乔峰。（下图中连线的数字表示两个点之间的距离）

<img src="./images/study-network-16.png" width=300>

既然都是掌门，互相都连着网线，就互相发送 BPDU 来比功夫呗。这一比就发现，有人是岳不群，有人是封不平，赢的接着当掌门，输的就只好做小弟了。当掌门的还会继续发 BPDU，而输的人就没有机会了。它们只有在收到掌门发的 BPDU 的时候，转发一下，表示服从命令。 

<img src="./images/study-network-17.png" width=300>

数字表示优先级。就像这个图，5 和 6 碰见了，6 的优先级低，所以乖乖做小弟。于是一个小门派形成，5 是掌门，6 是小弟。其他诸如 1-7、2-8、3-4 这样的小门派，也诞生了。于是江湖出现了很多小的门派，小的门派，接着合并。

合并的过程会出现以下四种情形，我分别来介绍。

##### 情形一：掌门遇到掌门

当 5 碰到了 1，掌门碰见掌门，1 觉得自己是掌门，5 也刚刚跟别人 PK 完成为掌门。这俩掌门比较功夫，最终 1 胜出。于是输掉的掌门 5 就会率领所有的小弟归顺。结果就是 1 成为大掌门。

<img src="./images/study-network-18.png" width=300>

##### 情形二：同门相遇

同门相遇可以是掌门与自己的小弟相遇，这说明存在“环”了。这个小弟已经通过其他门路拜在你门下，结果你还不认识，就 PK 了一把。结果掌门发现这个小弟功夫不错，不应该级别这么低，就把它招到门下亲自带，那这个小弟就相当于升职了。
我们再来看，假如 1 和 6 相遇。6 原来就拜在 1 的门下，只不过 6 的上司是 5，5 的上司是 1。1 发现，6 距离我才只有 2，比从 5 这里过来的 5（=4+1）近多了，那 6 就直接汇报给我吧。于是，5 和 6 分别汇报给 1。

<img src="./images/study-network-19.png" width=300>

同门相遇还可以是小弟相遇。这个时候就要比较谁和掌门的关系近，当然近的当大哥。刚才 5 和 6 同时汇报给 1 了，后来 5 和 6 再比较功夫的时候发现，5 你直接汇报给 1 距离是 4，如果 5 汇报给 6 再汇报给 1，距离只有 2+1=3，所以 5 干脆拜 6 为上司。

##### 情形三：掌门与其他帮派小弟相遇

小弟拿本帮掌门和这个掌门比较，赢了，这个掌门拜入门来。输了，会拜入新掌门，并且逐渐拉拢和自己连接的兄弟，一起弃暗投明。

<img src="./images/study-network-20.png" width=300>

例如，2 和 7 相遇，虽然 7 是小弟，2 是掌门。就个人武功而言，2 比 7 强，但是 7 的掌门是 1，比 2 牛，所以没办法，2 要拜入 7 的门派，并且连同自己的小弟都一起拜入。

##### 情形四：不同门小弟相遇

各自拿掌门比较，输了的拜入赢的门派，并且逐渐将与自己连接的兄弟弃暗投明。  

<img src="./images/study-network-21.png" width=300>

例如，5 和 4 相遇。虽然 4 的武功好于 5，但是 5 的掌门是 1，比 4 牛，于是 4 拜入 5 的门派。后来当 3 和 4 相遇的时候，3 发现 4 已经叛变了，4 说我现在老大是 1，比你牛，要不你也来吧，于是 3 也拜入 1。

这样最终生成一棵树。这样以来有环路的图就变成没有环路的树，从而解决环路问题。

### 如何解决广播问题和安全问题？VLAN

毕竟机器多了，交换机也多了，就算交换机比 Hub 智能一些，但是还是难免有广播的问题，一大波机器，相关的部门、不相关的部门，广播一大堆，性能就下来了。就像一家公司，创业的时候，一二十个人，坐在一个会议室，有事情大家讨论一下，非常方便。但是如果变成了 50 个人，全在一个会议室里面吵吵，就会乱的不得了。

你们公司有不同的部门，有的部门需要保密的，比如人事部门，肯定要讨论升职加薪的事儿。由于在同一个广播域里面，很多包都会在一个局域网里面飘啊飘，碰到了一个会抓包的程序员，就能抓到这些包，如果没有加密，就能看到这些敏感信息了。还是上面的例子，50 个人在一个会议室里面七嘴八舌的讨论，其中有两个 HR，那他们讨论的问题，肯定被其他人偷偷听走了。

那咋办，分部门，分会议室呗。那我们就来看看怎么分。

- 物理隔离。每个部门设一个单独的会议室，对应到网络方面，就是每个部门有单独的交换机，配置单独的子网，这样部门之间的沟通就需要路由器了。路由器咱们还没讲到，以后再说。这样的问题在于，有的部门人多，有的部门人少。人少的部门慢慢人会变多，人多的部门也可能人越变越少。如果每个部门有单独的交换机，口多了浪费，少了又不够用。
- 虚拟隔离，就是用我们常说的 **VLAN** ，或者叫虚拟局域网。使用了 VLAN 后原来的二层头上回加上一个 TAG 如下所示。

![](./images/study-network-22.png)

TAG 里面有一个 VLAN ID，一共 12 位。如果我们买的交换机是支持 VLAN 的，当这个交换机把二层的头取下来的时候，就能够识别这个 VLAN ID。这样只有相同 VLAN 的包，才会互相转发，不同 VLAN 的包，是看不到的。这样广播问题和安全问题就都能够解决了。

![](./images/study-network-23.png)

对于支持 VLAN 的交换机，有一种口叫作 Trunk 口。它可以转发属于任何 VLAN 的口。交换机之间通过这种口相互连接。

### Q&A
1. STP 协议能够很好的解决环路问题，但是也有它的缺点，你能举几个例子吗？
	STP 对于跨地域甚至跨国组织的网络支持，就很难做了，计算量太大。	
	一个是某个交换机状态发生变化的时候，整个树需要重新构建，另一个是被破开的环的链路被浪费了。
2. 在一个比较大的网络中，如果两台机器不通，你知道应该用什么方式调试吗？
	先ping，不通的话traceroute，参数逐渐加一。

