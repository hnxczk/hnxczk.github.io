# 趣谈网络协议学习记录
## 0. 开篇词
略
## 1. 为什么要学习网络协议？
### 协议三要素
```
public class HelloWorld {
	public static void main(String[] args) {
		System.out.println("Hello World!");
	}
}
```
上面是计算机语言中的一种，它可以看成程序员控制一台计算机工作的协议。具备了协议的三要素。

- 语法，就是这一段内容要符合一定的规则和格式。例如，括号要成对，结束要使用分号等。
- 语义，就是这一段内容要代表某种意义。例如数字减去数字是有意义的，数字减去文本一般来说就没有意义。
- 顺序，就是先干啥，后干啥。例如，可以先加上某个数值，然后再减去某个数值。

```
HTTP/1.1 200 OK
Date: Tue, 27 Mar 2018 16:50:26 GMT
Content-Type: text/html;charset=UTF-8
Content-Language: zh-CN

<!DOCTYPE html>
<html>
<head>
<base href="https://pages.kaola.com/" />
<meta charset="utf-8"/> <title> 网易考拉 3 周年主会场 </title>
```
上面是 HTTP 协议，同样符合协议的三要素

- 语法，也就是说，只有按照上面那个格式来，浏览器才认。例如，上来是状态，然后是首部，然后是内容。
- 语义，就是要按照约定的意思来。例如，状态 200，表述的意思是网页成功返回。如果不成功，就是我们常见的“404”。
- 顺序，你一点浏览器，就是发送出一个 HTTP 请求，然后才有上面那一串 HTTP 返回的东西。
 综上可以看出所有的协议都有语法、语义、顺序这三大要素。

### 从浏览器里面下单到浏览器呈现内容这一过程中涉及的协议

1. 浏览器中点击下单后浏览器根据 URL 通过地址簿协议 DNS 或者更加精准的地址簿查找协议HTTPDNS去查找 IP 地址。
2. 浏览器就开始打包它的请求。使用 HTTP 协议或者进行加密传输的 HTTPS 协议。协议里面都会写明“你要买什么和买多少”。
	
	![](./images/study-network-1.png)
	
3. 上面 DNS、HTTP 所处的层称之为**应用层**。
4. 接下来由**传输层**来进行处理。传输层有两种协议，一种是无连接的协议 UDP，一种是面向连接的协议 TCP。所谓的面向连接意思就是，TCP 会保证这个包能够到达目的地。如果不能到达，就会重新发送，直至到达。TCP 协议里面会有两个端口，一个是浏览器监听的端口，一个是电商的服务器监听的端口。操作系统往往通过端口来判断，它得到的包应该给哪个进程。

	![](./images/study-network-2.png)

5. 然后是**网络层**的 IP 协议。在 IP 协议里面会有源 IP 地址，即浏览器所在机器的 IP 地址和目标 IP 地址。

	![](./images/study-network-3.png)

6. IP 地址相当于门牌号，可以通过它看出这个目标 IP 地址是本地人，还是外地人。如果是外地的就需要先查找网关。
7. 由于操作系统启动的时候，就会被 DHCP 协议配置 IP 地址，以及默认的网关的 IP 地址 192.168.1.1。这样以来可以通过 ARP 协议获取网关的 MAC 地址。这样以来就把 IP 包交给了 **MAC层**。
	
	![](./images/study-network-4.png)
	
8. 网关（往往是一个路由器）收到包之后，会根据自己的路由表，判断下一步到某个 IP 地址应该怎么走。
9. 路由器有点像玄奘西行路过的一个个国家的一个个城关。每个城关都连着两个国家，每个国家相当于一个局域网，在每个国家内部，都可以使用本地的地址 MAC 进行通信。
10. 一旦跨越城关，就需要拿出 IP 头来，里面写着贫僧来自东土大唐（就是源 IP 地址），欲往西天拜佛求经（指的是目标 IP 地址）。路过宝地，借宿一晚，明日启行，请问接下来该怎么走啊？
11. 城关往往是知道这些“知识”的，因为城关和临近的城关也会经常沟通。到哪里应该怎么走，这种沟通的协议称为路由协议，常用的有OSPF和BGP。
12. 走到最后一个城关知道了自己就是这个网络包要去的地方。于是，对着这个国家吼一声，谁是目标 IP 啊？目标服务器就会回复一个 MAC 地址。网络包过关后，通过这个 MAC 地址就能找到目标服务器。
13. 目标服务器发现 MAC 地址对上了，取下 MAC 头来，发送给操作系统的网络层。发现 IP 也对上了，就取下 IP 头。IP 头里会写上一层封装的是 TCP 协议，然后将其交给传输层，即 TCP 层。
14. 到达 TCP 层之后，TCP 头中有目标端口号，通过这个端口号，可以找到电商网站的进程正在监听这个端口号，假设一个 Tomcat，将这个包发给电商网站。
15. 电商网站的进程得到 HTTP 请求的内容，知道了要买东西，买多少。然后返回相应的内容的 HTTPS 的包。这个包，会像来的时候一样，经过千难万险到达你的个人电脑，最终进入浏览器，显示支付成功。

## 2. 网络分层的真实含义是什么？

### 不恰当的比喻
教科书或者老师往往会打一个十分不恰当的比喻：为什么网络要分层呀？因为不同的层次之间有不同的沟通方式，这个叫作协议。例如，一家公司也是分“层次”的，分总经理、经理、组长、员工。总经理之间有他们的沟通方式，经理和经理之间也有沟通方式，同理组长和员工。

#### 不恰当的原因
**所有不能表示出层层封装含义的比喻，都是不恰当的。** 在上面例子中总经理握手，不需要员工在吧，总经理之间谈什么，不需要员工参与吧，但是网络世界不是这样的。

比如 TCP 在三次握手的时候，IP 层和 MAC 层在做什么呢？当然是 TCP 发送每一个消息，都会带着 IP 层和 MAC 层了。因为，TCP 每发送一个消息，IP 层和 MAC 层的所有机制都要运行一遍。而你只看到 TCP 三次握手了，其实，IP 层和 MAC 层为此也忙活好久了。

**只要是在网络上跑的包，都是完整的。可以有下层没上层，绝对不可能有上层没下层。**

所以对 TCP 协议来说，三次握手也好，重试也好，只要想发出去包，就要有 IP 层和 MAC 层，不然是发不出去的。

### 更好的例子-发快递
1. 你准备发一件快递给一个朋友。
2. 快递员查询收件地址的邮编（DNS请求）
3. 打包快递，贴上快递单。（封装请求， 会话层）
4. 快递员封装一层盒子贴上快递单带回网店(传输层）
5. 到快递点检查是否区域快件（网络层）
6. 将快件交给运输车（链路层）
7. 各个快递转运中心（物理层）
8. 快件到达收件市转运中心（物理层）
9. 转运输车（链路层）
10. 到达区域分发（网络层）
11. 网点派送（传输层）
12. 快递员方面签收（会话层）
13. 拆开检查（表示层）
14. 收到快递（应用层）

## 3. ifconfig：最熟悉又陌生的命令行
### 命令行中怎么查看 IP 地址
在 Windows 上是 ipconfig，在 Linux 上是 ifconfig 或者 ip addr。
### IP 地址是一个网卡在网络世界的通讯地址，相当于我们现实世界的门牌号码。



